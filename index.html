<!DOCTYPE html><html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (IndexedDB)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg1:#eef2ff; --bg2:#f7f8ff; --ink:#0f172a; --muted:#6b7280; --brand:#2563eb; --brand-2:#4f46e5; --ok:#16a34a; --warn:#f59e0b; --danger:#ef4444; --card:#ffffff; --border:#e5e7eb;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font:16px/1.5 'Noto Sans Thai', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; color:var(--ink); background:linear-gradient(180deg,var(--bg1),var(--bg2)) fixed; -webkit-tap-highlight-color: transparent;}
    .container{max-width:860px; margin:0 auto; padding:24px 16px 120px}
    .title{display:flex; align-items:center; gap:12px; font-weight:800; font-size:clamp(28px,6vw,48px); letter-spacing:.3px}
    .subtitle{color:var(--muted); margin-top:4px}
    .card{background:var(--card); border:1px solid var(--border); border-radius:20px; box-shadow:0 10px 30px rgba(2,6,23,.08); padding:18px; margin-top:18px}
    .card h3{margin:8px 0 10px; font-size:20px}
    .row{display:flex; gap:10px; align-items:center}
    .stack{display:flex; flex-direction:column; gap:10px}
    input[type="text"], textarea, select{width:100%; font:inherit; padding:14px 16px; border-radius:14px; border:1px solid var(--border); outline:none; background:#fff}
    textarea{min-height:120px; resize:vertical}
    .hint{color:var(--muted); font-size:13px}
    .error{color:var(--danger); font-weight:600; margin-top:8px}
    .btn{user-select:none; cursor:pointer; border:none; border-radius:16px; padding:14px 18px; font-weight:700; font-size:16px; transition:.2s transform ease, .2s opacity; display:inline-flex; align-items:center; justify-content:center; gap:8px}
    .btn:active{transform:scale(.98)}
    .btn-primary{background:linear-gradient(180deg,var(--brand),var(--brand-2)); color:#fff}
    .btn-ghost{background:#f3f4f6; color:#111827}
    .btn-danger{background:linear-gradient(180deg,#f43f5e,#ef4444); color:#fff}
    .btn-ok{background:linear-gradient(180deg,#10b981,#059669); color:#fff}
    .btn-warning{background:linear-gradient(180deg,#f59e0b,#d97706); color:#fff}
    .btn-big{padding:16px 22px; font-size:18px; border-radius:18px}
    .chips{display:flex; gap:10px; flex-wrap:wrap; margin-top:8px}
    .chip{display:flex; align-items:center; gap:8px; background:#f3f4f6; padding:10px 14px; border-radius:999px; border:1px solid var(--border); font-weight:600}
    .chip button{border:none; background:transparent; width:28px; height:28px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; cursor:pointer}
    .chip.active{background:#e0e7ff; border-color:#c7d2fe}
    .list{display:flex; flex-direction:column; gap:12px; margin-top:10px}
    .item{border:1px solid var(--border); background:#fff; border-radius:16px; padding:14px}
    .item-header{display:flex; align-items:center; justify-content:space-between; gap:12px}
    .stamp{color:var(--muted); font-size:12px}
    .item-actions{display:flex; gap:8px; flex-wrap:wrap}
    .item pre{white-space:pre-wrap; word-break:break-word; margin:8px 0 0}
    .toolbar{display:flex; gap:10px; flex-wrap:wrap}
    .placeholder{display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; padding:32px 12px; color:var(--muted)}
    .search{display:flex; gap:10px; align-items:center}
    .pill{font-weight:700; padding:8px 12px; background:#eef2ff; border:1px solid #e0e7ff; border-radius:999px}
    .footer{position:fixed; left:0; right:0; bottom:0; background:rgba(255,255,255,.9); border-top:1px solid var(--border); backdrop-filter: blur(10px); padding:8px 12px}
    .toast{position:fixed; left:50%; transform:translateX(-50%); bottom:24px; background:#111827; color:white; padding:12px 16px; border-radius:12px; opacity:0; pointer-events:none; transition:.3s opacity,.3s transform; box-shadow:0 10px 30px rgba(0,0,0,.2);}
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-6px)}
  </style>
</head>
<body>
  <div class="container">
    <div class="title">üìù <span>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</span></div>
    <div class="subtitle">IndexedDB ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏‡∏™‡∏π‡∏á + ‡∏™‡∏≥‡∏£‡∏≠‡∏á/‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏ü‡∏•‡πå JSON ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏ç‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢</div><!-- ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà -->
<section class="card" id="categoryCard">
  <h3>üìÅ ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</h3>
  <div class="row">
    <input id="categoryInput" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡∏°‡πà" maxlength="40" />
    <button id="addCategoryBtn" class="btn btn-primary btn-big">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
  </div>
  <div class="hint">‡πÑ‡∏°‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏ô 100 ‡∏´‡∏°‡∏ß‡∏î (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∑‡πà‡∏ô)</div>
  <div id="catError" class="error" style="display:none">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</div>
  <div class="chips" id="categoryChips"></div>
</section>

<!-- ‡πÅ‡∏™‡∏î‡∏á/‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° -->
<section class="card" id="messageCard">
  <h3 id="messageCardTitle">üí¨ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</h3>
  <div id="messagePanel" class="stack" style="display:none">
    <div class="row" style="align-items:stretch">
      <textarea id="messageInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‚Ä¶" style="flex:1"></textarea>
      <div class="stack" style="min-width:210px">
        <button id="saveMsgBtn" class="btn btn-ok btn-big">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</button>
        <button id="clearMsgBtn" class="btn btn-ghost btn-big">‡∏•‡πâ‡∏≤‡∏á</button>
      </div>
    </div>
    <div class="toolbar">
      <div class="search" style="flex:1">
        <input id="searchInput" type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ"/>
        <span id="countPill" class="pill">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
      </div>
      <input id="importFile" type="file" accept="application/json" style="display:none" />
      <button id="exportBtn" class="btn btn-primary btn-big">‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      <button id="importBtn" class="btn btn-warning btn-big">‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô</button>
      <button id="deleteCatBtn" class="btn btn-danger btn-big">‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ</button>
    </div>
    <div class="list" id="messageList"></div>
  </div>
  <div id="placeholder" class="placeholder">
    <div style="font-size:56px">üóíÔ∏è</div>
    <div style="max-width:520px">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</div>
  </div>
</section>

  </div>  <div id="toast" class="toast" role="status" aria-live="polite"></div>  <script>
  ;(()=>{
    // ---------------- IndexedDB Helper ----------------
    const DB_NAME='snippetDB.th.v1';
    const DB_VERSION=1;
    let dbPromise=null;

    function openDB(){
      if(dbPromise) return dbPromise;
      dbPromise = new Promise((resolve, reject)=>{
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onupgradeneeded = (e)=>{
          const db = req.result;
          if(!db.objectStoreNames.contains('categories')){
            const cat = db.createObjectStore('categories', {keyPath:'id'});
            cat.createIndex('byName','name',{unique:false});
            cat.createIndex('byCreated','createdAt');
          }
          if(!db.objectStoreNames.contains('items')){
            const it = db.createObjectStore('items', {keyPath:'id'});
            it.createIndex('byCategory','categoryId');
            it.createIndex('byCreated','createdAt');
          }
        };
        req.onsuccess = ()=> resolve(req.result);
        req.onerror = ()=> reject(req.error);
      });
      return dbPromise;
    }

    function tx(storeNames, mode='readonly'){ return openDB().then(db=>db.transaction(storeNames, mode)); }
    function store(t, name){ return t.objectStore(name); }

    async function getAll(storeName){
      const t = await tx([storeName]);
      const s = store(t, storeName);
      return new Promise((res,rej)=>{
        const arr=[]; const req=s.openCursor();
        req.onsuccess=()=>{ const c=req.result; if(c){ arr.push(c.value); c.continue(); } else res(arr); };
        req.onerror=()=>rej(req.error);
      });
    }

    async function put(storeName, obj){ const t=await tx([storeName],'readwrite'); await new Promise((res,rej)=>{ const r=store(t,storeName).put(obj); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error); }); }
    async function remove(storeName, key){ const t=await tx([storeName],'readwrite'); await new Promise((res,rej)=>{ const r=store(t,storeName).delete(key); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error); }); }
    async function getByIndex(storeName, indexName, query){ const t=await tx([storeName]); const s=store(t,storeName).index(indexName); return new Promise((res,rej)=>{ const arr=[]; const r=s.openCursor(IDBKeyRange.only(query)); r.onsuccess=()=>{ const c=r.result; if(c){ arr.push(c.value); c.continue(); } else res(arr); }; r.onerror=()=>rej(r.error); }); }

    // ---------------- Utilities ----------------
    const els = {
      categoryInput: document.getElementById('categoryInput'),
      addCategoryBtn: document.getElementById('addCategoryBtn'),
      catError: document.getElementById('catError'),
      categoryChips: document.getElementById('categoryChips'),
      messageCardTitle: document.getElementById('messageCardTitle'),
      messagePanel: document.getElementById('messagePanel'),
      messageInput: document.getElementById('messageInput'),
      saveMsgBtn: document.getElementById('saveMsgBtn'),
      clearMsgBtn: document.getElementById('clearMsgBtn'),
      deleteCatBtn: document.getElementById('deleteCatBtn'),
      messageList: document.getElementById('messageList'),
      placeholder: document.getElementById('placeholder'),
      searchInput: document.getElementById('searchInput'),
      countPill: document.getElementById('countPill'),
      toast: document.getElementById('toast'),
      exportBtn: document.getElementById('exportBtn'),
      importBtn: document.getElementById('importBtn'),
      importFile: document.getElementById('importFile'),
    };

    function uid(){ return (Date.now().toString(36) + Math.random().toString(36).slice(2,8)); }
    function nowISO(){ return new Date().toISOString(); }
    function fmt(ts){ const d=new Date(ts); return d.toLocaleString(undefined,{hour12:false}); }
    function toast(msg){ els.toast.textContent = msg; els.toast.classList.add('show'); setTimeout(()=>els.toast.classList.remove('show'), 1600); }

    let selectedId = localStorage.getItem('snippet.selectedId') || null;

    // ---------------- Category Logic ----------------
    async function listCategories(){
      const cats = await getAll('categories');
      // sort newest first
      cats.sort((a,b)=> new Date(b.createdAt)-new Date(a.createdAt));
      return cats;
    }

    async function addCategory(name){
      name=(name||'').trim(); if(!name) return toast('‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà');
      const cats = await listCategories();
      if(cats.some(c=>c.name.toLowerCase()===name.toLowerCase())) return toast('‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß');
      const obj={id:uid(), name, createdAt:nowISO()};
      await put('categories', obj);
      selectedId=obj.id; localStorage.setItem('snippet.selectedId', selectedId);
      els.categoryInput.value='';
      render(); toast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß');
    }

    async function deleteCategory(){
      if(!selectedId) return;
      const cats = await listCategories();
      const name = cats.find(c=>c.id===selectedId)?.name || '';
      if(!confirm('‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î "'+name+'" ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
      // delete items in this category
      const items = await getByIndex('items','byCategory', selectedId);
      for(const it of items){ await remove('items', it.id); }
      await remove('categories', selectedId);
      const left = (await listCategories());
      selectedId = left[0]?.id || null; localStorage.setItem('snippet.selectedId', selectedId||'');
      render(); toast('‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß');
    }

    // ---------------- Message Logic ----------------
    async function addMessage(text){
      if(!selectedId) return toast('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà');
      text=(text||'').trim(); if(!text) return toast('‡πÇ‡∏õ‡∏£‡∏î‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°');
      await put('items',{id:uid(), categoryId:selectedId, text, createdAt:nowISO(), updatedAt:null});
      els.messageInput.value='';
      renderList(); toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß');
    }

    async function updateMessage(id, newText){
      const t = await tx(['items'],'readwrite');
      const s = t.objectStore('items');
      const g = s.get(id);
      g.onsuccess = ()=>{ const item=g.result; if(!item) return; item.text=newText; item.updatedAt=nowISO(); s.put(item); };
      g.onerror = ()=>console.warn(g.error);
      t.oncomplete = ()=>{ renderList(); toast('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß'); };
    }

    async function deleteMessage(id){
      if(!confirm('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
      await remove('items', id); renderList(); toast('‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
    }

    async function copyMessage(text){
      try{ await navigator.clipboard.writeText(text); toast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß'); }
      catch(e){
        const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select();
        try{ document.execCommand('copy'); toast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß'); }catch(_) { alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); }
        ta.remove();
      }
    }

    // ---------------- Export / Import ----------------
    async function exportAll(){
      const cats = await getAll('categories');
      const items = await getAll('items');
      const data = {schema:'snippet-v1', exportedAt: nowISO(), categories: cats, items: items};
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const ts = new Date().toISOString().replace(/[:T]/g,'-').split('.')[0];
      a.download = `snippets-backup-${ts}.json`;
      a.href = url; a.click(); URL.revokeObjectURL(url);
      toast('‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå .json ‡πÅ‡∏•‡πâ‡∏ß');
    }

    async function importAll(file){
      if(!file) return;
      const text = await file.text();
      let data=null; try{ data=JSON.parse(text);}catch(e){ alert('‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON'); return; }
      if(data?.schema!=='snippet-v1' || !Array.isArray(data.categories) || !Array.isArray(data.items)){
        alert('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); return;
      }
      if(!confirm('‡∏Å‡∏≤‡∏£‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏à‡∏∞ "‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà" ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
      const db = await openDB();
      await new Promise((res,rej)=>{
        const t = db.transaction(['categories','items'],'readwrite');
        t.objectStore('categories').clear();
        t.objectStore('items').clear();
        t.oncomplete=()=>res(); t.onerror=()=>rej(t.error);
      });
      for(const c of data.categories){ await put('categories', c); }
      for(const it of data.items){ await put('items', it); }
      // restore selection if possible
      selectedId = data.categories[0]?.id || null; localStorage.setItem('snippet.selectedId', selectedId||'');
      render(); toast('‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß');
    }

    // ---------------- Render ----------------
    async function render(){
      const cats = await listCategories();
      const chipWrap = els.categoryChips; chipWrap.innerHTML='';
      if(!selectedId && cats.length>0){ selectedId = cats[0].id; localStorage.setItem('snippet.selectedId', selectedId); }
      if(cats.length===0){
        els.messageCardTitle.textContent='üí¨ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°';
        els.messagePanel.style.display='none';
        els.placeholder.style.display='flex';
      } else {
        els.placeholder.style.display='none';
        els.messagePanel.style.display='flex';
      }
      for(const c of cats){
        const chip = document.createElement('div'); chip.className='chip'+(selectedId===c.id?' active':'');
        const span = document.createElement('span'); span.textContent=c.name;
        const btnDel = document.createElement('button'); btnDel.title='‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î'; btnDel.innerHTML='‚úï';
        btnDel.onclick=(e)=>{ e.stopPropagation(); if(selectedId!==c.id){ if(!confirm('‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î "'+c.name+'" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return; remove('categories', c.id).then(()=>render()); } else { deleteCategory(); } };
        chip.append(span, btnDel);
        chip.onclick=()=>{ selectedId=c.id; localStorage.setItem('snippet.selectedId',selectedId); render(); };
        chipWrap.appendChild(chip);
      }

      if(selectedId){
        const cats2 = await listCategories();
        const name = cats2.find(x=>x.id===selectedId)?.name || '';
        els.messageCardTitle.textContent = 'üóÇÔ∏è ‡∏´‡∏°‡∏ß‡∏î: '+name;
        renderList();
      } else {
        els.messageList.innerHTML='';
      }
    }

    async function renderList(){
      if(!selectedId){ els.messageList.innerHTML=''; return; }
      const q = els.searchInput.value.trim().toLowerCase();
      const all = await getByIndex('items','byCategory', selectedId);
      all.sort((a,b)=> new Date(b.createdAt)-new Date(a.createdAt));
      const items = q? all.filter(x=>x.text.toLowerCase().includes(q)) : all;
      els.countPill.textContent = items.length+' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
      const wrap = els.messageList; wrap.innerHTML='';
      if(items.length===0){ const d=document.createElement('div'); d.className='placeholder'; d.innerHTML='<div style="font-size:42px">üîé</div><div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ô‡∏µ‡πâ</div>'; wrap.appendChild(d); return; }
      for(const it of items){
        const div = document.createElement('div'); div.className='item';
        const head = document.createElement('div'); head.className='item-header';
        const time = document.createElement('div'); time.className='stamp'; time.textContent=(it.updatedAt? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î '+fmt(it.updatedAt)+' ¬∑ ' : '') + '‡∏™‡∏£‡πâ‡∏≤‡∏á ' + fmt(it.createdAt);
        const actions = document.createElement('div'); actions.className='item-actions';
        const btnEdit = makeBtn('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç','btn-warning');
        const btnCopy = makeBtn('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å','btn-ghost');
        const btnDel  = makeBtn('‡∏•‡∏ö','btn-danger');
        actions.append(btnEdit, btnCopy, btnDel);
        head.append(time, actions);
        const pre = document.createElement('pre'); pre.textContent=it.text;
        div.append(head, pre);
        wrap.appendChild(div);
        // events
        btnCopy.onclick=()=>copyMessage(it.text);
        btnDel.onclick=()=>deleteMessage(it.id);
        btnEdit.onclick=()=>startEdit(div,it);
      }
    }

    function makeBtn(label, cls){ const b=document.createElement('button'); b.className='btn '+cls+' btn-big'; b.textContent=label; return b; }

    function startEdit(container, item){
      container.innerHTML='';
      const head = document.createElement('div'); head.className='item-header';
      const info = document.createElement('div'); info.className='stamp'; info.textContent='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ¬∑ ' + (item.updatedAt? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç '+fmt(item.updatedAt): '‡∏™‡∏£‡πâ‡∏≤‡∏á '+fmt(item.createdAt));
      const actions = document.createElement('div'); actions.className='item-actions';
      const btnSave = makeBtn('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å','btn-ok');
      const btnCancel = makeBtn('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å','btn-ghost');
      actions.append(btnSave, btnCancel); head.append(info, actions);
      const ta = document.createElement('textarea'); ta.value=item.text; ta.style.minHeight='140px';
      container.append(head, ta); ta.focus();
      btnSave.onclick=()=>{ const v=ta.value.trim(); if(!v) return toast('‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡πâ‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏á'); updateMessage(item.id, v); };
      btnCancel.onclick=()=>renderList();
    }

    // ---------------- Events ----------------
    els.addCategoryBtn.addEventListener('click', ()=>addCategory(els.categoryInput.value));
    els.categoryInput.addEventListener('keydown', e=>{ if(e.key==='Enter') addCategory(els.categoryInput.value); });
    els.saveMsgBtn.addEventListener('click', ()=>addMessage(els.messageInput.value));
    els.clearMsgBtn.addEventListener('click', ()=>{ els.messageInput.value=''; els.messageInput.focus(); });
    els.deleteCatBtn.addEventListener('click', deleteCategory);
    els.searchInput.addEventListener('input', renderList);
    els.exportBtn.addEventListener('click', exportAll);
    els.importBtn.addEventListener('click', ()=> els.importFile.click());
    els.importFile.addEventListener('change', e=> importAll(e.target.files[0]));

    // ---------------- Startup ----------------
    openDB().then(render).catch(err=>{ console.error(err); els.catError.textContent='‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ IndexedDB'; els.catError.style.display='block'; });
  })();
  </script></body>
</html>
