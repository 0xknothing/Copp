<!DOCTYPE html><html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà (IndexedDB)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Sarabun',sans-serif}
    .toast{transform:translateX(120%);transition:transform .3s ease-in-out;visibility:hidden}
    .toast.show{transform:translateX(0);visibility:visible}
    .modal{backdrop-filter:blur(4px)}
    .category-item:hover{transform:translateY(-2px);transition:transform .2s ease}
    .text-item{transition:all .3s ease}
    .text-item:hover{box-shadow:0 8px 25px rgba(0,0,0,.1)}
    .loader{border-top-color:#4f46e5;animation:spin 1s ease-in-out infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
  <!-- Header -->
  <header class="bg-white shadow-lg border-b-4 border-indigo-500">
    <div class="container mx-auto px-6 py-4">
      <h1 class="text-3xl font-bold text-gray-800 text-center">üìù ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</h1>
      <p class="text-center text-sm text-gray-500 mt-1">‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô IndexedDB ‚Äî ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï/‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ Firebase</p>
    </div>
  </header>  <div class="container mx-auto px-6 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Categories Section -->
      <div class="lg:col-span-1">
        <div class="bg-white rounded-xl shadow-lg p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold text-gray-800 flex items-center">üìÅ ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</h2>
            <button id="exportBtn" class="hidden sm:inline-flex bg-emerald-500 hover:bg-emerald-600 text-white px-3 py-2 rounded-lg text-sm">‡∏™‡∏≥‡∏£‡∏≠‡∏á (JSON)</button>
          </div>
          <!-- Add Category Form -->
          <div class="mb-6">
            <div class="flex gap-2">
              <input type="text" id="categoryInput" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡∏°‡πà..." class="flex-1 px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none" />
              <button id="addCategoryBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-3 rounded-xl font-semibold text-base">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
            </div>
            <div class="mt-3 flex items-center gap-2">
              <label for="importFile" class="bg-sky-600 hover:bg-sky-700 text-white px-3 py-2 rounded-lg text-sm cursor-pointer">‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô (Import)</label>
              <input id="importFile" type="file" accept="application/json" class="hidden" />
              <button id="clearAllBtn" class="ml-auto bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            </div>
          </div>
          <!-- Categories List -->
          <div id="categoriesList" class="space-y-2">
            <div id="categoryLoader" class="flex justify-center py-4"><div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-10 w-10"></div></div>
          </div>
        </div>
      </div><!-- Text Management Section -->
  <div class="lg:col-span-2">
    <div class="bg-white rounded-xl shadow-lg p-6 min-h-[300px]">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-semibold text-gray-800 flex items-center">üìÑ ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° <span id="selectedCategoryName" class="ml-2 text-indigo-600 font-normal"></span></h2>
      </div>
      <!-- Add Text Form -->
      <div id="addTextSection" class="mb-6 hidden">
        <div class="space-y-3">
          <textarea id="textContentInput" placeholder="‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°... (Ctrl+Enter ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°)" rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none resize-none"></textarea>
          <button id="addTextBtn" class="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-xl font-semibold">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</button>
        </div>
      </div>
      <!-- No Category Selected Message -->
      <div id="noCategoryMessage" class="text-center py-12">
        <div class="text-6xl mb-4">üìÇ</div>
        <p class="text-gray-500 text-lg">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</p>
      </div>
      <!-- Text List -->
      <div id="textsList" class="space-y-4 hidden">
        <div id="textLoader" class="hidden justify-center py-8"><div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-10 w-10"></div></div>
      </div>
    </div>
  </div>
</div>

  </div>  <!-- Edit Modal -->  <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 modal hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
      <h3 class="text-lg font-semibold text-gray-800 mb-4">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</h3>
      <div class="space-y-3">
        <textarea id="editContentInput" rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none resize-none"></textarea>
        <div class="flex gap-3 justify-end">
          <button id="cancelEditBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button id="saveEditBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
      </div>
    </div>
  </div>  <!-- Toast Notification -->  <div id="toast" class="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg toast z-50">
    <span id="toastMessage"></span>
  </div>  <script>
    // ===================== IndexedDB Layer =====================
    const DB_NAME = 'text-manager-db';
    const DB_VERSION = 1;
    const STORE_CATEGORIES = 'categories';
    const STORE_TEXTS = 'texts';

    let db = null;

    function openDB(){
      return new Promise((resolve, reject)=>{
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onupgradeneeded = (e)=>{
          const db = e.target.result;
          if(!db.objectStoreNames.contains(STORE_CATEGORIES)){
            const cat = db.createObjectStore(STORE_CATEGORIES, { keyPath:'id', autoIncrement:true });
            cat.createIndex('name','name',{unique:false});
          }
          if(!db.objectStoreNames.contains(STORE_TEXTS)){
            const txt = db.createObjectStore(STORE_TEXTS, { keyPath:'id', autoIncrement:true });
            txt.createIndex('categoryId','categoryId',{unique:false});
            txt.createIndex('createdAt','createdAt',{unique:false});
          }
        };
        req.onsuccess = ()=> resolve(req.result);
        req.onerror = ()=> reject(req.error);
      });
    }

    function tx(storeNames, mode='readonly'){
      return db.transaction(storeNames, mode);
    }

    // Categories CRUD
    async function addCategoryDB(name){
      const t = tx([STORE_CATEGORIES],'readwrite');
      const store = t.objectStore(STORE_CATEGORIES);
      return new Promise((res,rej)=>{
        const req = store.add({ name, createdAt: Date.now() });
        req.onsuccess = ()=> res(req.result);
        req.onerror = ()=> rej(req.error);
      });
    }

    async function listCategoriesDB(){
      const t = tx([STORE_CATEGORIES]);
      const store = t.objectStore(STORE_CATEGORIES);
      return new Promise((res,rej)=>{
        const arr = [];
        const req = store.openCursor();
        req.onsuccess = (e)=>{
          const cursor = e.target.result;
          if(cursor){ arr.push(cursor.value); cursor.continue(); }
          else res(arr);
        };
        req.onerror = ()=> rej(req.error);
      });
    }

    async function deleteCategoryDB(id){
      // delete texts under category then category
      const t = tx([STORE_TEXTS, STORE_CATEGORIES], 'readwrite');
      const textStore = t.objectStore(STORE_TEXTS);
      const index = textStore.index('categoryId');
      return new Promise((res,rej)=>{
        const range = IDBKeyRange.only(id);
        const delPromises = [];
        index.openCursor(range).onsuccess = (e)=>{
          const cursor = e.target.result;
          if(cursor){ delPromises.push(cursor.delete()); cursor.continue(); }
          else{
            // after texts deleted, delete category
            t.objectStore(STORE_CATEGORIES).delete(id).onsuccess = ()=> res();
          }
        };
        t.onerror = ()=> rej(t.error);
      });
    }

    // Texts CRUD
    async function addTextDB(categoryId, content){
      const t = tx([STORE_TEXTS],'readwrite');
      const store = t.objectStore(STORE_TEXTS);
      return new Promise((res,rej)=>{
        const req = store.add({ categoryId, content, createdAt: Date.now() });
        req.onsuccess = ()=> res(req.result);
        req.onerror = ()=> rej(req.error);
      });
    }

    async function listTextsDB(categoryId){
      const t = tx([STORE_TEXTS]);
      const idx = t.objectStore(STORE_TEXTS).index('categoryId');
      return new Promise((res,rej)=>{
        const range = IDBKeyRange.only(categoryId);
        const items = [];
        idx.openCursor(range, 'prev').onsuccess = (e)=>{
          const cursor = e.target.result;
          if(cursor){ items.push(cursor.value); cursor.continue(); }
          else{
            // sort newest first
            items.sort((a,b)=> b.createdAt - a.createdAt);
            res(items);
          }
        };
        t.onerror = ()=> rej(t.error);
      });
    }

    async function updateTextDB(id, content){
      const t = tx([STORE_TEXTS],'readwrite');
      const store = t.objectStore(STORE_TEXTS);
      return new Promise((res,rej)=>{
        store.get(id).onsuccess = (e)=>{
          const data = e.target.result; if(!data) return rej(new Error('not found'));
          data.content = content;
          store.put(data).onsuccess = ()=> res();
        };
        t.onerror = ()=> rej(t.error);
      });
    }

    async function deleteTextDB(id){
      const t = tx([STORE_TEXTS],'readwrite');
      return new Promise((res,rej)=>{
        t.objectStore(STORE_TEXTS).delete(id).onsuccess = ()=> res();
        t.onerror = ()=> rej(t.error);
      });
    }

    async function countTextsByCategoryDB(categoryId){
      const t = tx([STORE_TEXTS]);
      const idx = t.objectStore(STORE_TEXTS).index('categoryId');
      return new Promise((res,rej)=>{
        const range = IDBKeyRange.only(categoryId);
        let c = 0;
        idx.openCursor(range).onsuccess = (e)=>{
          const cursor = e.target.result; if(cursor){ c++; cursor.continue(); } else res(c);
        };
        t.onerror = ()=> rej(t.error);
      });
    }

    // Backup & Restore
    async function exportAllDB(){
      const [cats, texts] = await Promise.all([listCategoriesDB(), listAllTextsDB()]);
      return { version: 1, exportedAt: new Date().toISOString(), categories: cats, texts };
    }
    async function listAllTextsDB(){
      const t = tx([STORE_TEXTS]);
      const store = t.objectStore(STORE_TEXTS);
      return new Promise((res,rej)=>{
        const arr=[]; store.openCursor().onsuccess=(e)=>{const cur=e.target.result; if(cur){arr.push(cur.value); cur.continue();} else res(arr)};
        t.onerror = ()=> rej(t.error);
      });
    }
    async function clearAllDB(){
      const t = tx([STORE_TEXTS, STORE_CATEGORIES], 'readwrite');
      return Promise.all([
        new Promise((res,rej)=>{ t.objectStore(STORE_TEXTS).clear().onsuccess=()=>res(); }),
        new Promise((res,rej)=>{ t.objectStore(STORE_CATEGORIES).clear().onsuccess=()=>res(); })
      ]);
    }
    async function importAllDB(payload){
      if(!payload || !Array.isArray(payload.categories) || !Array.isArray(payload.texts)) throw new Error('‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
      await clearAllDB();
      // Insert keeping original IDs if exist (fallback to auto)
      await new Promise((res,rej)=>{
        const t = tx([STORE_CATEGORIES, STORE_TEXTS], 'readwrite');
        const cs = t.objectStore(STORE_CATEGORIES);
        const ts = t.objectStore(STORE_TEXTS);
        // Categories
        (payload.categories||[]).forEach(c=>{
          if(c.id==null){ cs.add({ name:c.name, createdAt:c.createdAt||Date.now() }); }
          else{ cs.put(c); }
        });
        // Texts
        (payload.texts||[]).forEach(x=>{
          if(x.id==null){ ts.add({ categoryId:x.categoryId, content:x.content, createdAt:x.createdAt||Date.now() }); }
          else{ ts.put(x); }
        });
        t.oncomplete = ()=> res();
        t.onerror = ()=> rej(t.error);
      });
    }

    // ===================== UI Layer =====================
    let selectedCategory = null; // {id, name}

    document.addEventListener('DOMContentLoaded', async ()=>{
      db = await openDB();
      bindUI();
      await refreshCategories();
    });

    function bindUI(){
      qs('#addCategoryBtn').addEventListener('click', onAddCategory);
      qs('#categoryInput').addEventListener('keypress', (e)=>{ if(e.key==='Enter') onAddCategory(); });
      qs('#addTextBtn').addEventListener('click', onAddText);
      qs('#textContentInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter' && e.ctrlKey) onAddText(); });
      qs('#cancelEditBtn').addEventListener('click', closeEditModal);
      qs('#saveEditBtn').addEventListener('click', saveEdit);
      qs('#exportBtn').addEventListener('click', onExportJSON);
      qs('#importFile').addEventListener('change', onImportJSON);
      qs('#clearAllBtn').addEventListener('click', onClearAll);
      // Click outside modal to close
      qs('#editModal').addEventListener('click', (e)=>{ if(e.target===e.currentTarget) closeEditModal(); });
    }

    // ------- Category UI -------
    async function refreshCategories(){
      setCategoryLoader(true);
      const cats = await listCategoriesDB();
      const container = qs('#categoriesList');
      setCategoryLoader(false);
      if(!cats.length){ container.innerHTML = '<p class="text-gray-500 text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</p>'; return; }
      // Get counts in parallel
      const counts = await Promise.all(cats.map(c=>countTextsByCategoryDB(c.id)));
      container.innerHTML = cats.map((c,i)=> renderCategoryItem(c, counts[i])).join('');
    }

    function renderCategoryItem(c, count){
      const active = selectedCategory && selectedCategory.id===c.id;
      return `
        <div data-id="${c.id}" class="category-item flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50 cursor-pointer ${active?'bg-indigo-50 border-indigo-300':'border-gray-200'}" onclick="selectCategory(${c.id}, '${escapeHTML(c.name)}')">
          <button class="flex-1 text-left font-medium pointer-events-none ${active?'text-indigo-600':'text-gray-700'}">
            ${escapeHTML(c.name)} <span class="ml-1 text-xs text-gray-400">(${count})</span>
          </button>
          <button onclick="event.stopPropagation(); deleteCategory(event, ${c.id}, '${escapeHTML(c.name)}')" class="text-red-500 hover:text-red-700 ml-2 p-1" title="‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà">üóëÔ∏è</button>
        </div>`;
    }

    function setCategoryLoader(show){
      qs('#categoryLoader').style.display = show? 'flex':'none';
    }

    async function onAddCategory(){
      const input = qs('#categoryInput');
      const name = input.value.trim();
      if(!name) return showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà','error');
      const btn = qs('#addCategoryBtn'); btn.disabled=true; btn.textContent='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°...';
      try{ await addCategoryDB(name); input.value=''; showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'); await refreshCategories(); }
      catch(e){ console.error(e); showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà','error'); }
      finally{ btn.disabled=false; btn.textContent='‡πÄ‡∏û‡∏¥‡πà‡∏°'; }
    }

    window.selectCategory = async function(id, name){
      selectedCategory = { id, name };
      qs('#selectedCategoryName').textContent = `(${name})`;
      qs('#noCategoryMessage').classList.add('hidden');
      qs('#addTextSection').classList.remove('hidden');
      qs('#textsList').classList.remove('hidden');
      // highlight
      await refreshCategories();
      await refreshTexts();
    }

    window.deleteCategory = async function(evt, id, name){
      evt.stopPropagation();
      if(!confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà "${name}" ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
      try{ await deleteCategoryDB(id); if(selectedCategory && selectedCategory.id===id){ selectedCategory=null; resetTextPanel(); } showToast('‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'); await refreshCategories(); }
      catch(e){ console.error(e); showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà','error'); }
    }

    // ------- Text UI -------
    function resetTextPanel(){
      qs('#selectedCategoryName').textContent='';
      qs('#noCategoryMessage').classList.remove('hidden');
      qs('#addTextSection').classList.add('hidden');
      qs('#textsList').classList.add('hidden');
      qs('#textsList').innerHTML='';
    }

    async function refreshTexts(){
      if(!selectedCategory) return;
      setTextLoader(true);
      const items = await listTextsDB(selectedCategory.id);
      const container = qs('#textsList');
      setTextLoader(false);
      if(!items.length){ container.innerHTML = '<p class="text-gray-500 text-center py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ô‡∏µ‡πâ</p>'; return; }
      container.innerHTML = items.map(renderTextItem).join('');
    }

    function renderTextItem(item){
      const created = item.createdAt ? new Date(item.createdAt).toLocaleString('th-TH') : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
      return `
        <div class="text-item bg-gray-50 border border-gray-200 rounded-lg p-4">
          <div class="flex justify-between items-start mb-2">
            <div class="flex-1">
              <p class="text-gray-700 whitespace-pre-wrap">${escapeHTML(item.content)}</p>
            </div>
            <div class="flex gap-2 ml-4">
              <button onclick="copyText(\`${escapeForTemplateLiteral(item.content)}\`)" class="text-blue-600 hover:text-blue-800 p-1 text-xl" title="‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å">üìã</button>
              <button onclick="editText(${item.id}, \`${escapeForTemplateLiteral(item.content)}\`)" class="text-green-600 hover:text-green-800 p-1 text-xl" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">‚úèÔ∏è</button>
              <button onclick="deleteText(${item.id})" class="text-red-600 hover:text-red-800 p-1 text-xl" title="‡∏•‡∏ö">üóëÔ∏è</button>
            </div>
          </div>
          <p class="text-xs text-gray-400 mt-2">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${created}</p>
        </div>`;
    }

    function setTextLoader(show){
      const l = qs('#textLoader');
      l.classList[show? 'remove':'add']('hidden');
      l.classList.add('flex');
    }

    async function onAddText(){
      if(!selectedCategory) return;
      const ta = qs('#textContentInput');
      const content = ta.value.trim();
      if(!content) return showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°','error');
      const btn = qs('#addTextBtn'); btn.disabled=true; btn.textContent='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°...';
      try{ await addTextDB(selectedCategory.id, content); ta.value=''; showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'); await refreshTexts(); await refreshCategories(); }
      catch(e){ console.error(e); showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°','error'); }
      finally{ btn.disabled=false; btn.textContent='‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°'; }
    }

    window.copyText = async function(content){
      try{
        if(navigator.clipboard && window.isSecureContext){ await navigator.clipboard.writeText(content); }
        else{ // fallback
          const ta = document.createElement('textarea'); ta.value = content; ta.style.position='fixed'; ta.style.opacity='0'; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
        }
        showToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
      }catch(err){ showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏î‡πâ','error'); }
    }

    window.editText = function(id, current){
      window.__editingTextId = id;
      qs('#editContentInput').value = current;
      qs('#editModal').classList.remove('hidden');
      qs('#editModal').classList.add('flex');
    }

    function closeEditModal(){
      qs('#editModal').classList.add('hidden');
      qs('#editModal').classList.remove('flex');
      window.__editingTextId = null;
    }

    async function saveEdit(){
      const id = window.__editingTextId; if(!id || !selectedCategory) return;
      const content = qs('#editContentInput').value.trim();
      if(!content) return showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°','error');
      try{ await updateTextDB(id, content); closeEditModal(); showToast('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'); await refreshTexts(); }
      catch(e){ console.error(e); showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å','error'); }
    }

    window.deleteText = async function(id){
      if(!selectedCategory) return;
      if(!confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
      try{ await deleteTextDB(id); showToast('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'); await refreshTexts(); await refreshCategories(); }
      catch(e){ console.error(e); showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö','error'); }
    }

    // ------- Backup/Restore UI -------
    async function onExportJSON(){
      try{
        const data = await exportAllDB();
        const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `text-manager-backup-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast('‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå JSON ‡πÅ‡∏•‡πâ‡∏ß');
      }catch(e){ console.error(e); showToast('‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','error'); }
    }

    async function onImportJSON(e){
      const file = e.target.files?.[0]; if(!file) return;
      try{
        const text = await file.text();
        const json = JSON.parse(text);
        await importAllDB(json);
        showToast('‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
        // refresh UI
        selectedCategory = null; resetTextPanel(); await refreshCategories();
      }catch(err){ console.error(err); showToast('‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß','error'); }
      finally{ e.target.value = ''; }
    }

    async function onClearAll(){
      if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ')) return;
      await clearAllDB(); selectedCategory=null; resetTextPanel(); await refreshCategories(); showToast('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
    }

    // ------- Utils -------
    function qs(sel){ return document.querySelector(sel); }
    function showToast(message, type='success'){
      const toast = qs('#toast'); const span = qs('#toastMessage');
      span.textContent = message;
      toast.className = `fixed top-4 right-4 text-white px-6 py-3 rounded-lg shadow-lg toast z-50 ${type==='error'?'bg-red-500':'bg-green-500'}`;
      toast.classList.add('show'); setTimeout(()=> toast.classList.remove('show'), 2500);
    }
    function escapeHTML(str=''){
      return String(str).replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[m]));
    }
    function escapeForTemplateLiteral(str=''){
      return String(str).replace(/`/g,'\\`').replace(/\$\{/g,'\\${');
    }
  </script></body>
</html>
